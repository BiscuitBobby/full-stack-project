<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCB Device Manager</title>
    <style>
        /* --- GLOBAL STYLES & VARIABLES --- */
        :root {
            --bg-color: #1c1c1c;
            --surface-color: #2a2a2a;
            --border-color: #444;
            --text-color: #e0e0e0;
            --text-muted-color: #9e9e9e;
            --primary-color: #4CAF50;
            --accent-color: #d4af37;
            --modal-backdrop-color: rgba(0, 0, 0, 0.7);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 40px;
        }

        /* --- HEADER --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 60px;
        }

        header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        header p {
            color: var(--text-muted-color);
        }

        button {
            font-family: var(--font-family);
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            padding: 10px 16px;
            transition: background-color 0.2s, color 0.2s, opacity 0.2s;
            border: 1px solid transparent;
        }

        button.primary, .add-device-btn {
            background-color: var(--surface-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        
        button.primary:hover, .add-device-btn:hover {
            background-color: #3e3e3e;
        }
        
        button.action {
            background-color: var(--primary-color);
            color: white;
        }
        
        button.secondary {
             background-color: transparent;
             color: var(--text-muted-color);
             border-color: var(--border-color);
        }

        button.secondary:hover {
            background-color: var(--surface-color);
            color: var(--text-color);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- ERROR/SUCCESS MESSAGES --- */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .message.error {
            background-color: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .message.success {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        /* --- MAIN CONTENT & EMPTY STATE --- */
        main {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #empty-state {
            text-align: center;
            margin-top: 100px;
            color: var(--text-muted-color);
        }

        #empty-state .icon {
            font-size: 48px;
            margin-bottom: 24px;
        }
        
        #empty-state h2 {
            font-size: 20px;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        #empty-state p {
            margin-bottom: 24px;
        }

        /* --- DEVICE GRID & CARDS --- */
        #device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            width: 100%;
        }

        .device-card {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .device-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-card .card-header h3 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .device-card .card-header span.date {
            font-size: 12px;
            color: var(--text-muted-color);
        }

        .device-card .complexity-tag {
            background-color: var(--accent-color);
            color: #111;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            align-self: flex-start;
        }
        
        .device-card img {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            object-fit: cover;
        }

        .device-card .card-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 14px;
            color: var(--text-muted-color);
        }
        
        .device-card .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .device-card .info-item svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            fill: currentColor;
        }

        .device-card .chat-btn {
            width: 100%;
            margin-top: auto;
            background-color: transparent;
            border: 1px solid var(--border-color);
        }
        
        .device-card .chat-btn:hover {
            background-color: #3e3e3e;
        }

        /* --- MODAL STYLES --- */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-backdrop-color);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1000;
        }

        .modal-backdrop.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--surface-color);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        
        .modal-backdrop.visible .modal {
            transform: scale(1);
        }
        
        .modal-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-muted-color);
            font-size: 24px;
            line-height: 1;
            cursor: pointer;
            padding: 4px;
        }
        
        .modal-close-btn:hover {
            color: var(--text-color);
        }

        .modal h2 {
            font-size: 20px;
            margin-bottom: 24px;
            padding-right: 40px;
        }

        .modal label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .modal input[type="text"] {
            width: 100%;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-color);
            font-size: 14px;
            margin-bottom: 20px;
            font-family: var(--font-family);
        }
        
        .modal input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .modal input[readonly] {
            background-color: var(--surface-color);
            cursor: default;
        }

        #drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
            position: relative;
            margin-bottom: 20px;
        }
        
        #drop-zone.dragover {
            border-color: var(--primary-color);
        }

        #drop-zone #upload-prompt p {
            color: var(--text-muted-color);
            margin: 4px 0;
        }

        #drop-zone #upload-prompt span {
            font-size: 12px;
            color: #666;
        }

        #image-preview-container {
            position: relative;
        }

        #image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }
        
        #image-preview-container p {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.6);
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        /* --- Analysis View --- */
        #modal-analysis-view .analysis-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .analysis-results-box {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .analysis-results-box .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .analysis-results-box .complexity-tag {
             background-color: var(--accent-color);
             color: #111;
             padding: 4px 8px;
             border-radius: 12px;
             font-size: 12px;
             font-weight: 500;
        }
        
        .analysis-results-box .result-item {
            margin-bottom: 12px;
        }
        
        .analysis-results-box .result-item h4 {
            font-size: 12px;
            color: var(--text-muted-color);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .analysis-results-box .components-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .analysis-results-box .component-tag {
            background-color: #3e3e3e;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 13px;
        }
        
        .analysis-results-box .result-value {
            background-color: var(--bg-color);
            padding: 8px 12px;
            border-radius: 6px;
        }

        .hidden {
            display: none !important;
        }

        /* --- Loading spinner --- */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-muted-color);
            border-radius: 50%;
            border-top-color: var(--text-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div>
            <h1>PCB Device Manager</h1>
            <p>Upload and analyze PCB images, then chat about your devices</p>
        </div>
        <button class="add-device-btn primary">+ Add Device</button>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Empty State -->
        <div id="empty-state">
            <div class="icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 21.5C9 21.7761 8.77614 22 8.5 22H2.5C2.22386 22 2 21.7761 2 21.5V17.5C2 17.2239 2.22386 17 2.5 17H8.5C8.77614 17 9 17.2239 9 17.5V21.5Z" stroke="#9E9E9E" stroke-width="1.5"/>
                    <path d="M7 17V8.5C7 8.22386 6.77614 8 6.5 8H3.5C3.22386 8 3 8.22386 3 8.5V10.5C3 10.7761 3.22386 11 3.5 11H6.5C6.77614 11 7 11.2239 7 11.5V13.5C7 13.7761 6.77614 14 6.5 14H3.5C3.22386 14 3 14.2239 3 14.5V17" stroke="#9E9E9E" stroke-width="1.5"/>
                    <path d="M15 2.5C15 2.22386 15.2239 2 15.5 2H21.5C21.7761 2 22 2.22386 22 2.5V6.5C22 6.77614 21.7761 7 21.5 7H15.5C15.2239 7 15 6.77614 15 6.5V2.5Z" stroke="#9E9E9E" stroke-width="1.5"/>
                    <path d="M17 7V15.5C17 15.7761 17.2239 16 17.5 16H20.5C20.7761 16 21 15.7761 21 15.5V13.5C21 13.2239 20.7761 13 20.5 13H17.5C17.2239 13 17 12.7761 17 12.5V10.5C17 10.2239 17.2239 10 17.5 10H20.5C20.7761 10 21 9.77614 21 9.5V7" stroke="#9E9E9E" stroke-width="1.5"/>
                    <rect x="9" y="8" width="6" height="8" rx="1" stroke="#9E9E9E" stroke-width="1.5"/>
                </svg>
            </div>
            <h2>No devices added yet</h2>
            <p>Upload your first PCB image to get started with AI analysis</p>
            <button class="add-device-btn primary">+ Add Your First Device</button>
        </div>

        <!-- Device Grid (initially hidden) -->
        <div id="device-grid" class="hidden">
            <!-- Device cards will be added here by JS -->
        </div>
    </main>

    <!-- Modal (initially hidden) -->
    <div id="modal-backdrop" class="modal-backdrop">
        <div id="modal" class="modal">
            <button id="modal-close-btn" class="modal-close-btn">×</button>
            
            <!-- Step 1 & 2 combined: Upload View -->
            <div id="modal-upload-view">
                <h2>Add New PCB Device</h2>
                
                <div id="message-container"></div>
                
                <label for="device-name">Device Name</label>
                <input type="text" id="device-name" placeholder="Enter device name (e.g., Arduino Uno, Custom Board)">
                
                <label for="drop-zone">PCB Image</label>
                <div id="drop-zone">
                    <div id="upload-prompt">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 12px;">
                            <path d="M12 16.5V3M12 3L16.5 7.5M12 3L7.5 7.5" stroke="#9E9E9E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M21 12v5.5c0 1.933-2.239 3.5-5 3.5s-5-1.567-5-3.5V12" stroke="#9E9E9E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M3 12v5.5c0 1.933 2.239 3.5 5 3.5s5-1.567 5-3.5V12" stroke="#9E9E9E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <h3>Upload PCB Image</h3>
                        <p>Click to select or drag and drop</p>
                        <span>PNG, JPG up to 10MB</span>
                    </div>
                    <div id="image-preview-container" class="hidden">
                        <img id="image-preview" src="#" alt="PCB Preview">
                        <p>Click to change image</p>
                    </div>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/png,image/jpeg,image/jpg">

                <div id="modal-upload-actions" class="modal-actions hidden">
                    <button id="analyze-btn" class="primary">Analyze PCB</button>
                    <button id="remove-btn" class="secondary">Remove</button>
                </div>
            </div>

            <!-- Step 3: Analysis View (initially hidden) -->
            <div id="modal-analysis-view" class="hidden">
                <h2>Add New PCB Device</h2>
                
                <div id="analysis-message-container"></div>
                
                <label for="device-name-readonly">Device Name</label>
                <input type="text" id="device-name-readonly" readonly>

                <div class="analysis-status">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 7L9.00004 18L4 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Analysis Complete</span>
                </div>
                
                <div class="analysis-results-box">
                    <div class="results-header">
                        <h3>PCB Analysis Results</h3>
                        <span class="complexity-tag" id="complexity-display">Medium Complexity</span>
                    </div>
                    
                    <div class="result-item">
                        <h4>Detected Components</h4>
                        <div class="components-list" id="components-display">
                            <!-- Components will be populated here -->
                        </div>
                    </div>
                    <div class="result-item">
                        <h4>Operating Voltage</h4>
                        <div class="result-value" id="voltage-display">3.3V - 5V</div>
                    </div>
                    <div class="result-item" style="margin-bottom:0;">
                        <h4>Description</h4>
                        <p id="description-display" style="font-size: 14px; color: var(--text-muted-color); line-height: 1.5;">This appears to be a microcontroller development board with various passive components and an LED indicator. The board shows good design practices with proper component placement.</p>
                    </div>
                </div>

                <div class="modal-actions">
                    <button id="save-btn" class="primary">Save Device</button>
                    <button id="reanalyze-btn" class="secondary">Re-analyze</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- API Base URL ---
            const API_URL = 'http://localhost:8000';

            // --- DOM Element Selectors ---
            const addDeviceBtns = document.querySelectorAll('.add-device-btn');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modal = document.getElementById('modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalUploadView = document.getElementById('modal-upload-view');
            const modalAnalysisView = document.getElementById('modal-analysis-view');
            const deviceNameInput = document.getElementById('device-name');
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const uploadPrompt = document.getElementById('upload-prompt');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const modalUploadActions = document.getElementById('modal-upload-actions');
            const analyzeBtn = document.getElementById('analyze-btn');
            const removeBtn = document.getElementById('remove-btn');
            const deviceNameReadonly = document.getElementById('device-name-readonly');
            const saveBtn = document.getElementById('save-btn');
            const reanalyzeBtn = document.getElementById('reanalyze-btn');
            const emptyState = document.getElementById('empty-state');
            const deviceGrid = document.getElementById('device-grid');
            const messageContainer = document.getElementById('message-container');
            const analysisMessageContainer = document.getElementById('analysis-message-container');

            let uploadedFile = null;
            let analysisResults = null;

            // --- Utility Functions ---
            function showMessage(container, message, type = 'error') {
                container.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => {
                    if (container.firstChild) {
                        container.removeChild(container.firstChild);
                    }
                }, 5000);
            }

            function clearMessages(container) {
                container.innerHTML = '';
            }
            
            function resetModal() {
                modalUploadView.classList.remove('hidden');
                modalAnalysisView.classList.add('hidden');
                deviceNameInput.value = '';
                fileInput.value = '';
                uploadedFile = null;
                analysisResults = null;
                uploadPrompt.classList.remove('hidden');
                imagePreviewContainer.classList.add('hidden');
                modalUploadActions.classList.add('hidden');
                imagePreview.src = '#';
                clearMessages(messageContainer);
                clearMessages(analysisMessageContainer);
            }

            function setButtonLoading(button, isLoading, loadingText = 'Loading...') {
                if (isLoading) {
                    button.disabled = true;
                    button.dataset.originalText = button.textContent;
                    button.innerHTML = `<span class="spinner"></span>${loadingText}`;
                } else {
                    button.disabled = false;
                    button.innerHTML = button.dataset.originalText || '...';
                }
            }
            
            function createDeviceCard(device) {
                const card = document.createElement('div');
                card.className = 'device-card';

                const createdAt = new Date(device.created_at).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });

                const voltageIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>`;
                const componentsIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2zm16 14H5V5h14v14zM8 7h8v2H8zm0 4h8v2H8zm0 4h5v2H8z"/></svg>`;
                
                const displayedComponents = device.components.length > 3 
                    ? `${device.components.slice(0, 3).join(', ')}...` 
                    : device.components.join(', ');

                card.innerHTML = `
                    <div class="card-header">
                        <h3>${device.name}</h3>
                        <span class="date">${createdAt}</span>
                    </div>
                    <img src="${API_URL}/static/images/${device.image_filename}" alt="${device.name}" loading="lazy">
                    <span class="complexity-tag">${device.complexity}</span>
                    <div class="card-info">
                        <div class="info-item">
                            ${voltageIcon}
                            <span>${device.operating_voltage}</span>
                        </div>
                        <div class="info-item">
                            ${componentsIcon}
                            <span>${displayedComponents}</span>
                        </div>
                    </div>
                    <button class="chat-btn secondary" disabled>Chat about this device</button>
                `;
                deviceGrid.appendChild(card);
            }
            
            function displayAnalysisResults(results) {
                // Populate the readonly device name
                deviceNameReadonly.value = deviceNameInput.value.trim();
                
                // Populate the analysis results
                document.getElementById('complexity-display').textContent = `${results.complexity}`;
                document.getElementById('voltage-display').textContent = results.operating_voltage;
                document.getElementById('description-display').textContent = results.description;

                const componentsContainer = document.getElementById('components-display');
                componentsContainer.innerHTML = ''; // Clear previous
                results.components.forEach(comp => {
                    const tag = document.createElement('span');
                    tag.className = 'component-tag';
                    tag.textContent = comp;
                    componentsContainer.appendChild(tag);
                });
            }

            // --- Modal Control ---
            const openModal = () => {
                modalBackdrop.classList.add('visible');
                document.body.style.overflow = 'hidden';
            };
            
            const closeModal = () => {
                modalBackdrop.classList.remove('visible');
                document.body.style.overflow = '';
                setTimeout(resetModal, 300);
            };

            addDeviceBtns.forEach(btn => btn.addEventListener('click', openModal));
            modalCloseBtn.addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', (e) => {
                if (e.target === modalBackdrop) closeModal();
            });

            // --- File Upload Handling ---
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            
            dropZone.addEventListener('dragover', (e) => { 
                e.preventDefault(); 
                dropZone.classList.add('dragover'); 
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('dragover');
                }
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
            });

            function handleFile(file) {
                clearMessages(messageContainer);
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    showMessage(messageContainer, 'Please upload a valid image file (PNG, JPG).');
                    return;
                }
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    showMessage(messageContainer, 'File size must be less than 10MB.');
                    return;
                }

                uploadedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    uploadPrompt.classList.add('hidden');
                    imagePreviewContainer.classList.remove('hidden');
                    modalUploadActions.classList.remove('hidden');
                };
                reader.onerror = () => showMessage(messageContainer, 'Error reading file. Please try again.');
                reader.readAsDataURL(file);
            }
            
            // --- Load existing devices on page load ---
            async function loadDevices() {
                try {
                    const response = await fetch(`${API_URL}/devices/`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const devices = await response.json();
                    
                    if (devices.length > 0) {
                        emptyState.classList.add('hidden');
                        deviceGrid.classList.remove('hidden');
                        deviceGrid.innerHTML = '';
                        devices.forEach(createDeviceCard);
                    } else {
                        emptyState.classList.remove('hidden');
                        deviceGrid.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error loading devices:', error);
                    if (error.message.includes('fetch')) {
                         showMessage(document.querySelector('main'), 'Could not connect to the backend. Please ensure the server is running.', 'error');
                    }
                }
            }

            // --- Modal Action Buttons ---
            removeBtn.addEventListener('click', () => {
                resetModal();
            });

            analyzeBtn.addEventListener('click', async () => {
                clearMessages(messageContainer);
                if (!deviceNameInput.value.trim()) {
                    showMessage(messageContainer, 'Please enter a device name.');
                    deviceNameInput.focus();
                    return;
                }
                if (!uploadedFile) {
                    showMessage(messageContainer, 'Please upload a PCB image.');
                    return;
                }
                
                setButtonLoading(analyzeBtn, true, 'Analyzing...');
                const formData = new FormData();
                formData.append('image', uploadedFile);

                try {
                    const response = await fetch(`${API_URL}/analyze-pcb/`, { method: 'POST', body: formData });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: 'Analysis failed' }));
                        throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                    }

                    analysisResults = await response.json();
                    displayAnalysisResults(analysisResults);
                    modalUploadView.classList.add('hidden');
                    modalAnalysisView.classList.remove('hidden');
                } catch (error) {
                    console.error('Analysis error:', error);
                    showMessage(messageContainer, `Analysis failed: ${error.message}`);
                } finally {
                    setButtonLoading(analyzeBtn, false);
                }
            });

            reanalyzeBtn.addEventListener('click', () => {
                clearMessages(analysisMessageContainer);
                modalAnalysisView.classList.add('hidden');
                modalUploadView.classList.remove('hidden');
            });

            saveBtn.addEventListener('click', async () => {
                clearMessages(analysisMessageContainer);
                if (!analysisResults || !uploadedFile) {
                    showMessage(analysisMessageContainer, 'No analysis data to save.');
                    return;
                }
                
                setButtonLoading(saveBtn, true, 'Saving...');
                const formData = new FormData();
                formData.append('name', deviceNameInput.value.trim()); 
                formData.append('complexity', analysisResults.complexity);
                formData.append('components', JSON.stringify(analysisResults.components));
                formData.append('operating_voltage', analysisResults.operating_voltage);
                formData.append('description', analysisResults.description);
                formData.append('image', uploadedFile);

                try {
                    const response = await fetch(`${API_URL}/devices/`, { method: 'POST', body: formData });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: 'Failed to save device.' }));
                        throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                    }
                    closeModal();
                    await loadDevices();
                } catch (error) {
                    console.error('Save error:', error);
                    showMessage(analysisMessageContainer, `Save failed: ${error.message}`);
                } finally {
                    setButtonLoading(saveBtn, false);
                }
            });
            
            // --- Initial Load ---
            loadDevices();
        });
    </script>
</body>
</html>